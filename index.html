<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Phone Tracking System</title>

<!-- VERSION -->
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 10px;
  }

  #appVersion {
    background: #222;
    color: #fff;
    padding: 8px;
    font-size: 14px;
    text-align: center;
    margin-bottom: 10px;
  }

  button {
    padding: 12px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 10px;
  }

  #loading {
    text-align: center;
    margin-top: 20px;
  }

  .task {
    background: #fff;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    box-shadow: 0 0 4px rgba(0,0,0,0.1);
  }

  .QUEUED { color: gray; }
  .CAPTURING { color: blue; }
  .UPLOADING { color: orange; }
  .COMPLETED { color: green; }
  .FAILED { color: red; }
</style>
</head>

<body>

<div id="appVersion"></div>

<button onclick="capturePhoto()">üì∏ Capture Photo</button>

<div id="loading">Loading tasks...</div>
<div id="taskList"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import {
  getDatabase,
  ref,
  push,
  update,
  get,
  query,
  orderByChild,
  limitToLast
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===============================
   CONFIG ‚Äî REPLACE WITH YOUR OWN
================================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",

  // ‚úÖ REQUIRED for Realtime Database
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",

  projectId: "driva-pwa",

  // ‚úÖ Correct web storage bucket
  storageBucket: "driva-pwa.appspot.com",

  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};
  
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===============================
   VERSION DISPLAY
================================= */
const VERSION = "v1.0.8";
document.getElementById("appVersion").innerText =
  `Version: ${VERSION} | Loaded: ${new Date().toLocaleString()}`;

/* ===============================
   LOCATION
================================= */
function getLocation() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      pos => resolve(pos.coords),
      () => reject("Location permission is required"),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

/* ===============================
   CAPTURE PHOTO (SIMULATED)
================================= */
window.capturePhoto = async function () {
  let coords;

  try {
    coords = await getLocation();
  } catch (err) {
    alert(err);
    return;
  }

  const taskRef = push(ref(db, "tasks"));
  const taskId = taskRef.key;

  await update(taskRef, {
    id: taskId,
    status: "QUEUED",
    latitude: coords.latitude,
    longitude: coords.longitude,
    capturedAt: new Date().toISOString(),
    uploadedAt: null,
    error: null
  });

  processUpload(taskId);
};

/* ===============================
   UPLOAD PROCESS (SIMULATED)
================================= */
async function processUpload(taskId) {
  const taskRef = ref(db, `tasks/${taskId}`);

  try {
    await update(taskRef, { status: "UPLOADING" });

    // simulate upload delay
    await new Promise(res => setTimeout(res, 3000));

    await update(taskRef, {
      status: "COMPLETED",
      uploadedAt: new Date().toISOString()
    });

  } catch (err) {
    await update(taskRef, {
      status: "FAILED",
      error: err.message || "Upload failed"
    });
  }
}

/* ===============================
   AUTO FAIL STUCK TASKS
================================= */
function autoFail(task) {
  if (!task.capturedAt) return;

  const age = Date.now() - new Date(task.capturedAt).getTime();
  const limit = 2 * 60 * 1000;

  if (
    (task.status === "QUEUED" || task.status === "UPLOADING") &&
    age > limit
  ) {
    update(ref(db, `tasks/${task.id}`), {
      status: "FAILED",
      error: "Timeout"
    });
  }
}

/* ===============================
   LOAD TASKS
================================= */
async function loadTasks() {
  const loadingEl = document.getElementById("loading");
  const listEl = document.getElementById("taskList");

  try {
    const q = query(
      ref(db, "tasks"),
      orderByChild("capturedAt"),
      limitToLast(20)
    );

    const snapshot = await get(q);
    const data = snapshot.val();

    if (!data) {
      listEl.innerHTML =
        "<div style='text-align:center;color:#666'>No tasks yet</div>";
      return;
    }

    renderTasks(Object.values(data));

  } catch (err) {
    console.error("üî• FIREBASE ERROR:", err);

    listEl.innerHTML = `
      <div style="color:red;padding:10px">
        <b>Failed to load tasks</b><br><br>
        <pre style="white-space:pre-wrap">${err.message}</pre>
      </div>
    `;
  } finally {
    loadingEl.style.display = "none";
  }
}

/* ===============================
   RENDER TASKS
================================= */
function renderTasks(tasks) {
  const container = document.getElementById("taskList");
  container.innerHTML = "";

  tasks.reverse().forEach(task => {
    autoFail(task);

    const div = document.createElement("div");
    div.className = `task ${task.status}`;

    div.innerHTML = `
      <div><strong>Status:</strong> ${task.status}</div>
      <div>üìç ${task.latitude}, ${task.longitude}</div>
      <div>üì∏ Captured: ${formatDate(task.capturedAt)}</div>
      <div>‚òÅÔ∏è Uploaded: ${task.uploadedAt ? formatDate(task.uploadedAt) : "-"}</div>
      ${task.error ? `<div>‚ùå ${task.error}</div>` : ""}
    `;

    container.appendChild(div);
  });
}

/* ===============================
   UTIL
================================= */
function formatDate(d) {
  return new Date(d).toLocaleString();
}

/* ===============================
   INIT
================================= */
loadTasks();
setInterval(loadTasks, 5000); // auto refresh
</script>

</body>
</html>
