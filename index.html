
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Driver PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    .task {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 6px;
    }
    .status {
      font-weight: bold;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-size: 16px;
    }
  </style>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</head>

<body>

<h2>ğŸ“‹ Driver Task List</h2>

<div id="tasks"></div>

<script>
// ===================== SAMPLE TASKS =====================
const tasks = [
  { id: "1", name: "Juan Dela Cruz", address: "123 Rizal St", status: "PENDING", lat: null, lng: null },
  { id: "2", name: "Maria Santos", address: "45 Del Pilar Ave", status: "PENDING", lat: null, lng: null }
];

const DB_NAME = "driver-pwa-db";

// ===================== INDEXED DB =====================
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore("queue", { keyPath: "id" });
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = () => reject("IndexedDB error");
  });
}

// ===================== RENDER UI =====================
function render() {
  const container = document.getElementById("tasks");
  container.innerHTML = "";

  tasks.forEach(task => {
    const div = document.createElement("div");
    div.className = "task";

    const locationInfo = (task.lat && task.lng)
      ? `<div>ğŸ“ Lat: ${task.lat.toFixed(6)}<br/>ğŸ“ Lng: ${task.lng.toFixed(6)}</div>`
      : "";

    div.innerHTML = `
      <div><strong>${task.name}</strong></div>
      <div>${task.address}</div>
      <div>Status: <span class="status">${task.status}</span></div>
      ${locationInfo}
      <button ${task.status !== "PENDING" ? "disabled" : ""}>
        ğŸ“· Upload Picture
      </button>
    `;

    div.querySelector("button").onclick = () => capture(task);
    container.appendChild(div);
  });
}

// ===================== CAPTURE PHOTO (FAST UX) =====================
function capture(task) {
  task.status = "OPENING CAMERA...";
  render();

  // ğŸ“· Open camera immediately
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.capture = "environment";

  input.onchange = async e => {
    if (!e.target.files.length) {
      task.status = "PENDING";
      render();
      return;
    }

    task.status = "GETTING LOCATION...";
    render();

    // ğŸ“ Get GPS AFTER photo
    navigator.geolocation.getCurrentPosition(
      async pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        task.lat = lat;
        task.lng = lng;

        const db = await openDB();
        const tx = db.transaction("queue", "readwrite");
        tx.objectStore("queue").put({
          id: task.id,
          photo: e.target.files[0],
          lat,
          lng,
          createdAt: Date.now()
        });

        task.status = navigator.onLine ? "UPLOADING" : "QUEUED";
        render();
        sync();
      },
      () => {
        alert("Location permission is required.");
        task.status = "PENDING";
        render();
      },
      {
        enableHighAccuracy: false, // âš¡ faster
        timeout: 5000              // âš¡ no long freeze
      }
    );
  };

  input.click();
}

// ===================== SYNC ENGINE (MOCK SERVER) =====================
async function sync() {
  if (!navigator.onLine) return;

  const db = await openDB();
  const tx = db.transaction("queue", "readwrite");
  const store = tx.objectStore("queue");
  const req = store.getAll();

  req.onsuccess = () => {
    req.result.forEach(item => {
      setTimeout(() => {
        store.delete(item.id);
        const t = tasks.find(x => x.id === item.id);
        if (t) t.status = "DONE";
        render();
      }, 800);
    });
  };
}

window.addEventListener("online", sync);

// ===================== START APP =====================
render();
</script>

</body>
</html>
