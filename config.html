<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver UI Configuration</title>

<style>
body { font-family: Arial, sans-serif; background:#f3f3f3; padding:12px; }
h2 { text-align:center; }

.card {
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

input, select {
  width:100%;
  padding:8px;
  margin-top:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  margin-top:8px;
  padding:8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.primary { background:#007bff; color:#fff; }
.secondary { background:#555; color:#fff; }
.danger { background:#c0392b; color:#fff; }

.method-box {
  border:1px solid #ddd;
  border-radius:8px;
  padding:10px;
  margin-top:10px;
}

.required-row {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>‚öô Driver UI Configuration2.0.1</h2>

<div class="card">
  <label>Job Type</label>
  <input id="jobTypeInput">

  <label>Delivery Method</label>
  <input id="deliveryMethodInput">

  <button class="secondary" onclick="addDeliveryMethod()">‚ûï Add Delivery Method</button>
</div>

<div class="card">
  <h3>Delivery Methods</h3>
  <div id="methodsContainer"></div>
</div>

<div class="card">
  <button class="primary" onclick="saveConfig()">üíæ Save</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

const STATE = { jobType:"", methods:{} };
let IS_DIRTY = false;

/* ================= ADD DELIVERY METHOD ================= */
window.addDeliveryMethod = function () {
  const jobType = jobTypeInput.value.trim();
  const method = deliveryMethodInput.value.trim();

  if (!jobType || !method) {
    alert("Job Type and Delivery Method required");
    return;
  }

  STATE.jobType = jobType;

  if (STATE.methods[method]) {
    alert("Delivery Method already exists");
    return;
  }

  STATE.methods[method] = {};
  deliveryMethodInput.value = "";
  IS_DIRTY = true;
  renderMethods();
};

/* ================= RENDER ================= */
function renderMethods() {
  methodsContainer.innerHTML = "";

  Object.entries(STATE.methods).forEach(([method, fields]) => {
    const div = document.createElement("div");
    div.className = "method-box";

    div.innerHTML = `
      <b>${method}</b>
      <input class="field-label" placeholder="Field label (e.g. Payment Method)">
      <select class="field-type">
        <option value="text">Text</option>
        <option value="textarea">Textarea</option>
        <option value="radio">Radio</option>
      </select>
      <button class="secondary addField">‚ûï Add Field</button>

      <div class="field-list">
        ${Object.entries(fields).map(([key, f]) => `
          <div style="margin-top:10px;border-top:1px dashed #ccc;padding-top:10px;">
            <b>${f.label}</b> (${f.type})

          ${f.type === "radio" ? `
  <div style="margin-top:8px;border-top:1px dashed #ccc;padding-top:8px;">
    <b>Radio Options</b>

    ${(f.options || []).map((opt, idx) => `
      <div style="border:1px solid #ddd;padding:8px;margin-top:8px;border-radius:6px;">
        <input
          placeholder="Radio option label"
          value="${opt.value}"
          onchange="updateRadioOptionValue('${method}','${key}',${idx},this.value)"
        >

        <div style="margin-left:12px;margin-top:6px;">
          ${(opt.extraFields || []).map((ef, efIdx) => `
            <div style="margin-top:6px;">
              <input
                placeholder="Textbox label"
                value="${ef.label}"
                onchange="updateRadioExtraLabel('${method}','${key}',${idx},${efIdx},this.value)"
              >

              <label class="required-row">
                <input type="checkbox"
                  ${ef.required ? "checked" : ""}
                  onchange="updateRadioExtraRequired('${method}','${key}',${idx},${efIdx},this.checked)">
                <span>Required</span>
              </label>

              <button class="danger"
                onclick="removeRadioExtraField('${method}','${key}',${idx},${efIdx})">
                ‚ùå
              </button>
            </div>
          `).join("")}

          <button class="secondary"
            onclick="addRadioExtraField('${method}','${key}',${idx})">
            ‚ûï Add textbox for this option
          </button>
        </div>

        <button class="danger"
          style="margin-top:6px;"
          onclick="removeRadioOption('${method}','${key}',${idx})">
          ‚ùå Remove Option
        </button>
      </div>
    `).join("")}

    <button class="secondary"
      onclick="addRadioOption('${method}','${key}')">
      ‚ûï Add Radio Option
    </button>
  </div>
` : ""}  
          </div>
        `).join("")}
      </div>
    `;

    div.querySelector(".addField").onclick = () => {
      const label = div.querySelector(".field-label").value.trim();
      const type = div.querySelector(".field-type").value;

      if (!label) {
        alert("Please enter a field label");
        return;
      }

      const key = label.toLowerCase().replace(/\s+/g,"");

      STATE.methods[method][key] = {
        label,
        type,
        ...(type === "radio" ? { options: [] } : {})
      };

      IS_DIRTY = true;
      renderMethods();
    };

    methodsContainer.appendChild(div);
  });
}

/* ================= RADIO FUNCTIONS ================= */
window.addRadioOption = (method, field) => {
  STATE.methods[method][field].options.push({
    value:"",
    extraFields:[]
  });
  renderMethods();
};

window.updateRadioValue = (m,f,i,val) => {
  STATE.methods[m][f].options[i].value = val;
};

window.addExtraField = (m,f,i) => {
  STATE.methods[m][f].options[i].extraFields.push({
    label:"",
    required:false
  });
  renderMethods();
};

window.updateExtraLabel = (m,f,i,j,val) => {
  STATE.methods[m][f].options[i].extraFields[j].label = val;
};

window.updateExtraRequired = (m,f,i,j,val) => {
  STATE.methods[m][f].options[i].extraFields[j].required = val;
};

/* ================= SAVE ================= */
window.saveConfig = async function () {
  if (!STATE.jobType) {
    alert("Nothing to save");
    return;
  }

  await update(
    ref(db, `config/driverUI/jobTypes/${STATE.jobType}`),
    {
      deliveryMethods: STATE.methods,
      updatedAt: new Date().toISOString()
    }
  );

  alert("‚úÖ Configuration saved");
};

// ‚úÖ Add a radio option (no textbox yet)
window.addRadioOption = (method, fieldKey) => {
  const field = STATE.methods[method][fieldKey];
  if (!field.options) field.options = [];

  field.options.push({
    value: "",
    extraFields: []
  });

  IS_DIRTY = true;
  renderMethods();
};

// ‚úÖ Update radio option label
window.updateRadioOptionValue = (method, fieldKey, optIdx, value) => {
  STATE.methods[method][fieldKey].options[optIdx].value = value.trim();
  IS_DIRTY = true;
};

// ‚úÖ Add textbox under a specific radio option
window.addRadioExtraField = (method, fieldKey, optIdx) => {
  const opt = STATE.methods[method][fieldKey].options[optIdx];
  if (!opt.extraFields) opt.extraFields = [];

  opt.extraFields.push({
    label: "",
    type: "text",
    required: false
  });

  IS_DIRTY = true;
  renderMethods();
};

// ‚úÖ Update textbox label
window.updateRadioExtraLabel = (method, fieldKey, optIdx, fieldIdx, value) => {
  STATE.methods[method][fieldKey]
    .options[optIdx]
    .extraFields[fieldIdx].label = value;

  IS_DIRTY = true;
};

// ‚úÖ Toggle required for textbox
window.updateRadioExtraRequired = (method, fieldKey, optIdx, fieldIdx, value) => {
  STATE.methods[method][fieldKey]
    .options[optIdx]
    .extraFields[fieldIdx].required = value;

  IS_DIRTY = true;
};

// ‚ùå Remove textbox under option
window.removeRadioExtraField = (method, fieldKey, optIdx, fieldIdx) => {
  STATE.methods[method][fieldKey]
    .options[optIdx]
    .extraFields.splice(fieldIdx, 1);

  IS_DIRTY = true;
  renderMethods();
};

// ‚ùå Remove radio option
window.removeRadioOption = (method, fieldKey, optIdx) => {
  STATE.methods[method][fieldKey].options.splice(optIdx, 1);
  IS_DIRTY = true;
  renderMethods();
};
</script>

</body>
</html>
