<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver UI Configuration</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f3f3f3;
  padding:12px;
}
h2 { text-align:center; }

.tabs {
  display:flex;
  gap:8px;
  margin-bottom:12px;
}
.tabs button {
  flex:1;
  padding:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.tabs .active {
  background:#007bff;
  color:#fff;
}

.card {
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

label {
  font-weight:bold;
  font-size:13px;
  display:block;
  margin-top:10px;
}

input, select {
  width:100%;
  padding:8px;
  margin-top:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.primary { background:#007bff; color:#fff; }
.secondary { background:#555; color:#fff; }

.method-box {
  border:1px solid #ddd;
  border-radius:8px;
  padding:10px;
  margin-top:10px;
}

.field-row {
  background:#f7f7f7;
  padding:6px;
  border-radius:6px;
  margin-top:6px;
  font-size:13px;
}
</style>
</head>

<body>

<h2>‚öô Driver UI Configuration V1.0.5</h2>

<div class="tabs">
  <button id="tabAdd" class="active">‚ûï Add Job Type</button>
  <button id="tabUpdate">‚úèÔ∏è Update Job Type</button>
</div>

<div class="card" id="addSection">
  <label>Job Type</label>
  <input id="jobTypeInput" placeholder="e.g. TEST_BILLING">

  <label>Delivery Method</label>
  <input id="deliveryMethodInput" placeholder="e.g. D1-Received">

  <button class="secondary" onclick="addDeliveryMethod()">‚ûï Add Delivery Method</button>
</div>

<div class="card" id="updateSection" style="display:none">
  <label>Select Job Type</label>
  <select id="jobTypeSelect"></select>
</div>

<div class="card">
  <h3>Delivery Methods</h3>
  <div id="methodsContainer"></div>
</div>

<div class="card">
  <button class="primary" onclick="saveConfig()">üíæ Save</button>
  <button class="secondary" onclick="location.href='admin.html'">‚¨Ö Back</button>
</div>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, get, update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

const STATE = { jobType:"", methods:{} };

/* ===== TABS ===== */
tabAdd.onclick = () => {
  tabAdd.classList.add("active");
  tabUpdate.classList.remove("active");
  addSection.style.display = "block";
  updateSection.style.display = "none";
  resetState();
};

tabUpdate.onclick = async () => {
  resetState(); // üî• ADD THIS

  tabUpdate.classList.add("active");
  tabAdd.classList.remove("active");
  addSection.style.display = "none";
  updateSection.style.display = "block";
  await loadJobTypes();
};

/* ===== ADD DELIVERY METHOD ===== */
window.addDeliveryMethod = function () {
  const jobType = jobTypeInput.value.trim();
  const method = deliveryMethodInput.value.trim();

  if (!jobType || !method) {
    alert("Job Type and Delivery Method required");
    return;
  }

  STATE.jobType = jobType;

  if (!STATE.methods[method]) {
    STATE.methods[method] = {};

    // default Other Remarks
    STATE.methods[method].remarks = {
      label: "Other Remarks",
      type: "textarea",
      required: false
    };
  }

  deliveryMethodInput.value = "";
  renderMethods();
};

/* ===== ADD FIELD ===== */
function addField(method, container) {
  const label = container.querySelector(".field-label").value.trim();
  const type = container.querySelector(".field-type").value;
  const required = container.querySelector(".field-required").checked;

  if (!label) {
    alert("Please enter a description label");
    return;
  }

  const key = makeKey(label);

  if (STATE.methods[method][key]) {
    alert("Field already exists");
    return;
  }

  STATE.methods[method][key] = {
    label,
    type,
    required
  };

  container.querySelector(".field-label").value = "";
  container.querySelector(".field-required").checked = false;

  renderMethods();
}
  
/* ===== RENDER ===== */
function renderMethods() {
  methodsContainer.innerHTML = "";

  Object.entries(STATE.methods).forEach(([method, fields]) => {
    const div = document.createElement("div");
    div.className = "method-box";

    div.innerHTML = `
      <b>${method}</b>

      <input class="field-label" placeholder="Label (e.g. Received by)">
      <select class="field-type">
        <option value="text">Text</option>
        <option value="textarea">Textarea</option>
      </select>

      <label>
        <input type="checkbox" class="field-required"> Required
      </label>

      <button class="secondary add">‚ûï Add Description</button>

      <div class="field-list">
        ${Object.values(fields).map(f => `
          <div class="field-row">
            ${f.label} ‚Äî ${f.type} ${f.required ? "(required)" : ""}
          </div>
        `).join("")}
      </div>
    `;

    div.querySelector(".add").onclick = () => addField(method, div);
    methodsContainer.appendChild(div);
  });
}
  
/* ===== SAVE ===== */
window.saveConfig = async function () {
  if (!STATE.jobType || !Object.keys(STATE.methods).length) {
    alert("Nothing to save");
    return;
  }

  await update(
  ref(db, `config/driverUI/jobTypes/${STATE.jobType}`),
    {
      deliveryMethods: STATE.methods,
      updatedAt: new Date().toISOString()
    }
  );

  alert("‚úÖ Configuration saved successfully");
};
  

/* ===== LOAD EXISTING ===== */
async function loadJobTypes() {
  const snap = await get(ref(db,"config/driverUI/jobTypes"));
  const data = snap.val()||{};
  jobTypeSelect.innerHTML="<option value=''>Select</option>";
  Object.keys(data).forEach(j=>{
    const o=document.createElement("option");
    o.value=j; o.textContent=j;
    jobTypeSelect.appendChild(o);
  });

  jobTypeSelect.onchange=()=>{
    STATE.jobType=jobTypeSelect.value;
    STATE.methods=data[STATE.jobType]?.deliveryMethods||{};
    renderMethods();
  };
}

function resetState(){
  STATE.jobType="";
  STATE.methods={};
  methodsContainer.innerHTML="";
}

function makeKey(label) {
  return label
    .toLowerCase()
    .replace(/[^a-z0-9 ]/g, "")     // remove symbols
    .trim()
    .split(" ")
    .map((w, i) =>
      i === 0 ? w : w.charAt(0).toUpperCase() + w.slice(1)
    )
    .join("");
}
</script>

</body>
</html>
