<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver UI Configuration</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f3f3f3;
  padding:12px;
}

h2 { text-align:center; }

.card {
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

label {
  font-weight:bold;
  font-size:13px;
  display:block;
  margin-top:10px;
}

input, select, textarea {
  width:100%;
  padding:8px;
  margin-top:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
}

.primary { background:#007bff; color:#fff; }
.secondary { background:#555; color:#fff; }
.danger { background:#c0392b; color:#fff; }

.method-box {
  border:1px solid #ddd;
  border-radius:8px;
  padding:10px;
  margin-top:10px;
}

.field-row {
  background:#f7f7f7;
  padding:8px;
  border-radius:6px;
  margin-top:6px;
  font-size:13px;
}
</style>
</head>

<body>

<h2>âš™ Driver UI ConfigurationV1.0.2</h2>

<div class="card">
  <label>Job Type</label>
  <input id="jobTypeInput" placeholder="e.g. RTP">

  <label>Delivery Method</label>
  <input id="deliveryMethodInput" placeholder="e.g. N1-Received">

  <button class="secondary" onclick="addDeliveryMethod()">
    âž• Add Delivery Method
  </button>
</div>

<div class="card">
  <h3>Delivery Methods</h3>
  <div id="methodsContainer"></div>
</div>

<div class="card">
  <button class="primary" onclick="saveConfig()">ðŸ’¾ Save / Update Template</button>
  <button class="secondary" onclick="location.href='admin.html'">â¬… Back</button>
</div>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, update
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  projectId: "driva-pwa",
  storageBucket: "driva-pwa.firebasestorage.app",
  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== STATE ===== */
const STATE = {
  jobType: "",
  methods: {}
};

/* ===== ADD DELIVERY METHOD ===== */
window.addDeliveryMethod = function () {
  const jobType = jobTypeInput.value.trim();
  const method = deliveryMethodInput.value.trim();

  if (!jobType || !method) {
    alert("Job Type and Delivery Method required");
    return;
  }

  STATE.jobType = jobType;

  if (!STATE.methods[method]) {
    STATE.methods[method] = [];

    // default Other Remarks
    STATE.methods[method].push({
      key: "remarks",
      label: "Other Remarks",
      type: "textarea",
      required: false
    });
  }

  deliveryMethodInput.value = "";
  renderMethods();
};

/* ===== ADD FIELD ===== */
function addField(method, container) {
  console.log("addField fired for", method); // ðŸ‘ˆ DEBUG PROOF

  const label = container.querySelector(".field-label").value.trim();
  const type = container.querySelector(".field-type").value;
  const required = container.querySelector(".field-required").checked;

  if (!label) {
    alert("Please enter a description label");
    return;
  }

  STATE.methods[method].push({
    label,
    type,
    required
  });

  renderMethods();
}
  
/* ===== RENDER ===== */
function renderMethods() {
  const box = document.getElementById("methodsContainer");
  box.innerHTML = "";

  Object.entries(STATE.methods).forEach(([method, fields]) => {
    const div = document.createElement("div");
    div.className = "method-box";

    div.innerHTML = `
      <b>${method}</b>

      <label>Add Description / Field</label>
      <input class="field-label" placeholder="e.g. Received by">

      <select class="field-type">
        <option value="text">Text</option>
        <option value="textarea">Textarea</option>
      </select>

      <label>
        <input type="checkbox" class="field-required"> Required
      </label>

      <button class="secondary add-desc-btn">
        âž• Add Description
      </button>

      <div class="field-list">
        ${fields.map(f => `
          <div class="field-row">
            ${f.label} â€” ${f.type} ${f.required ? "(required)" : ""}
          </div>
        `).join("")}
      </div>
    `;

    // âœ… ATTACH EVENT LISTENER HERE
    div.querySelector(".add-desc-btn").addEventListener("click", () => {
      addField(method, div);
    });

    box.appendChild(div);
  });
}

  /* ===== SAVE ===== */
window.saveConfig = async function () {
  if (!STATE.jobType || !Object.keys(STATE.methods).length) {
    alert("Nothing to save");
    return;
  }

  const payload = {};

  Object.entries(STATE.methods).forEach(([method, fields]) => {
    payload[method] = { fields:{} };
    fields.forEach(f => {
      payload[method].fields[f.key] = {
        label: f.label,
        type: f.type,
        required: f.required
      };
    });
  });

  await update(
    ref(db, `config/driverUI/jobTypes/${STATE.jobType}`),
    { deliveryMethods: payload }
  );

  alert("âœ… Configuration saved");
};
</script>

</body>
</html>
