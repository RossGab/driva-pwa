<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver UI Config</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f3f3f3;
  padding:12px;
}

h2 { text-align:center; }

.box {
  background:#fff;
  padding:12px;
  border-radius:8px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

label {
  font-weight:bold;
  font-size:13px;
  display:block;
  margin-top:8px;
}

input, select, textarea, button {
  width:100%;
  padding:8px;
  margin-top:4px;
}

button {
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

button.secondary {
  background:#555;
}

.field, .option, .subfield {
  border:1px dashed #ccc;
  padding:8px;
  margin-top:8px;
}
</style>
</head>

<body>

<h2>âš™ Driver UI Configuration</h2>

<div class="box">
  <label>Job Type</label>
  <input id="jobType" placeholder="e.g. RTP">
  <button onclick="loadConfig()">Load / Create Template</button>
</div>

<div class="box">
  <h3>Fields</h3>
  <div id="fields"></div>
  <button onclick="addField()">âž• Add Field</button>
</div>

<div class="box">
  <button onclick="saveConfig()">ðŸ’¾ Save / Update Template</button>
</div>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, get, set
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  projectId: "driva-pwa",
  storageBucket: "driva-pwa.firebasestorage.app",
  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let CONFIG = { fields:{} };

/* ===== LOAD ===== */
window.loadConfig = async function () {
  const jobType = jobTypeInput();
  const snap = await get(ref(db, `config/driverUI/jobTypes/${jobType}`));
  CONFIG = snap.val() || { fields:{} };
  renderFields();
};

/* ===== ADD FIELD ===== */
window.addField = function () {
  const key = prompt("Field key (e.g. deliveryType)");
  if (!key) return;

  CONFIG.fields[key] = {
    label: "",
    type: "text",
    options: {}
  };

  renderFields();
};

/* ===== RENDER ===== */
function renderFields() {
  const box = document.getElementById("fields");
  box.innerHTML = "";

  Object.entries(CONFIG.fields).forEach(([key, f]) => {
    const div = document.createElement("div");
    div.className = "field";

    div.innerHTML = `
      <label>Field Key</label>
      <input value="${key}" disabled>

      <label>Label</label>
      <input value="${f.label || ""}"
        oninput="CONFIG.fields['${key}'].label=this.value">

      <label>Type</label>
      <select onchange="CONFIG.fields['${key}'].type=this.value; renderFields()">
        <option ${f.type==="text"?"selected":""}>text</option>
        <option ${f.type==="textarea"?"selected":""}>textarea</option>
        <option ${f.type==="radio"?"selected":""}>radio</option>
      </select>

      ${f.type==="radio" ? `
        <div>
          <button class="secondary"
            onclick="addOption('${key}')">âž• Add Option</button>
          ${renderOptions(key)}
        </div>
      ` : ""}
    `;

    box.appendChild(div);
  });
}

function renderOptions(fieldKey) {
  const f = CONFIG.fields[fieldKey];
  let html = "";

  Object.entries(f.options || {}).forEach(([optKey, opt]) => {
    html += `
      <div class="option">
        <label>Option Label</label>
        <input value="${opt.label || ""}"
          oninput="CONFIG.fields['${fieldKey}'].options['${optKey}'].label=this.value">

        <button class="secondary"
          onclick="addSubField('${fieldKey}','${optKey}')">
          âž• Required Sub-field
        </button>

        ${renderSubFields(fieldKey,optKey)}
      </div>
    `;
  });

  return html;
}

/* ===== ADD OPTION ===== */
window.addOption = function (fieldKey) {
  const key = prompt("Option key (e.g. N1-Received)");
  if (!key) return;

  CONFIG.fields[fieldKey].options[key] = {
    label: key,
    requires: {}
  };
  renderFields();
};

/* ===== SUB FIELDS ===== */
window.addSubField = function (fieldKey,optKey) {
  const key = prompt("Sub-field key (e.g. receivedBy)");
  if (!key) return;

  CONFIG.fields[fieldKey].options[optKey].requires[key] = {
    label: "",
    type: "text",
    required: true
  };
  renderFields();
};

function renderSubFields(fieldKey,optKey) {
  const req = CONFIG.fields[fieldKey].options[optKey].requires || {};
  let html = "";

  Object.entries(req).forEach(([k,v]) => {
    html += `
      <div class="subfield">
        <input value="${k}" disabled>
        <input placeholder="Label"
          value="${v.label || ""}"
          oninput="CONFIG.fields['${fieldKey}']
            .options['${optKey}']
            .requires['${k}'].label=this.value">
      </div>
    `;
  });

  return html;
}

/* ===== SAVE ===== */
window.saveConfig = async function () {
  const jobType = jobTypeInput();
  await set(
    ref(db, `config/driverUI/jobTypes/${jobType}`),
    CONFIG
  );
  alert("âœ… Template saved");
};

function jobTypeInput() {
  const v = document.getElementById("jobType").value.trim();
  if (!v) throw alert("Job Type required");
  return v;
}
</script>

</body>
</html>
