<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver UI Configuration Builder</title>

<style>
body { font-family: Arial, sans-serif; background:#f3f3f3; padding:12px; }
h2 { text-align:center; }

.card {
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

input, select {
  width:100%;
  padding:8px;
  margin-top:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

button {
  margin-top:8px;
  padding:8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}

.primary { background:#007bff; color:#fff; }
.secondary { background:#555; color:#fff; }
.danger { background:#c0392b; color:#fff; }

.method-box {
  border:1px solid #ddd;
  border-radius:8px;
  padding:10px;
  margin-top:10px;
}

.field-box {
  margin-top:10px;
  padding:10px;
  border-top:1px dashed #ccc;
}

.child-box {
  margin-left:12px;
  margin-top:8px;
  padding-left:8px;
  border-left:3px solid #ddd;
}

.required-row {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  margin-top:4px;
}
</style>
</head>

<body>

<h2>‚öô Driver UI Dynamic Configuration Builder V5.5</h2>

<div class="card">
  <label>Job Type</label>
  <input id="jobTypeInput" placeholder="e.g. BOV">

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
    <button class="secondary" onclick="loadConfigForEdit()">‚úèÔ∏è Load / Edit Config</button>
    <button class="secondary" onclick="resetBuilder()">üßπ New Config</button>
  </div>

  <label style="margin-top:10px">Delivery Method</label>
  <input id="deliveryMethodInput" placeholder="e.g. N1-Received">

  <button class="secondary" onclick="addDeliveryMethod()">‚ûï Add Delivery Method</button>
</div>

<div class="card">
  <h3>Delivery Methods</h3>
  <div id="methodsContainer"></div>
</div>

<div class="card">
  <h3>üëÄ Live Driver UI Preview</h3>
  <div id="previewContainer"></div>
</div>

<div class="card">
  <button class="primary" onclick="saveConfig()">üíæ Save Configuration</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

const STATE = {
  jobType: "",
  methods: {}
};

window.loadConfigForEdit = async function () {
  const jobType = jobTypeInput.value.trim();
  if (!jobType) return alert("Enter Job Type to edit");

  const snap = await get(
    ref(db, `config/driverUI/jobTypes/${jobType}/deliveryMethods`)
  );

  if (!snap.exists()) {
    alert("‚ùå No configuration found for " + jobType);
    return;
  }

  STATE.jobType = jobType;
  STATE.methods = snap.val() || {};

  renderMethods();
  renderPreview();

  alert("‚úèÔ∏è Loaded configuration for editing");
};

window.resetBuilder = function () {
  if (!confirm("Clear current configuration?")) return;

  STATE.jobType = "";
  STATE.methods = {};

  jobTypeInput.value = "";
  deliveryMethodInput.value = "";

  renderMethods();
  renderPreview();
};

window.addDeliveryMethod = function () {
  const jobType = jobTypeInput.value.trim();
  const method = deliveryMethodInput.value.trim();

  if (!jobType || !method) {
    alert("Job Type and Delivery Method are required");
    return;
  }

  STATE.jobType = jobType;

  if (!STATE.methods[method]) {
    STATE.methods[method] = { _order: [], fields: {} };
  }

  deliveryMethodInput.value = "";
  renderMethods();
  renderPreview();
};

function renderMethods() {
  methodsContainer.innerHTML = "";

  Object.entries(STATE.methods).forEach(([method, fields]) => {
    const div = document.createElement("div");
    div.className = "method-box";

    div.innerHTML = `
      <b>${method}</b>
      <button class="danger" style="float:right" onclick="removeDeliveryMethod('${method}')">‚ùå</button>

      <input class="field-label" placeholder="Field label (e.g. Received by, C100-Disconnected)">
      <select class="field-type">
        <option value="text">Text</option>
        <option value="textarea">Textarea</option>
        <option value="radio">Radio Button</option>
      </select>

      <button class="secondary addField">‚ûï Add Field</button>

      <div class="field-list"></div>
    `;

    const list = div.querySelector(".field-list");

    fields._order.forEach(key => {
      const f = fields.fields[key];
      list.innerHTML += renderField(method, key, f);
    });

    div.querySelector(".addField").onclick = () => {
      const label = div.querySelector(".field-label").value.trim();
      const type = div.querySelector(".field-type").value;

      if (!label) return alert("Field label required");

      const key = label.toLowerCase().replace(/[^a-z0-9]+/g,"_");

      const methodObj = STATE.methods[method];

      methodObj._order.push(key);
      
      methodObj.fields[key] = {
        label,
        type,
        required:false,
        ...(type==="radio" ? { fields:{ _order: [], options:{} } } : {})
      };

      renderMethods();
      renderPreview();
    };

    methodsContainer.appendChild(div);
  });
}

  function renderPreview() {
  const box = document.getElementById("previewContainer");
  box.innerHTML = "";

  Object.entries(STATE.methods).forEach(([method, mObj]) => {
    const section = document.createElement("div");
    section.className = "method-box";

    section.innerHTML = `<b>${method}</b>`;

    mObj._order.forEach(key => {
      const f = mObj.fields[key];

      const row = document.createElement("div");
      row.style.marginTop = "8px";

      let html = `<label>${f.label}${f.required ? " *" : ""}</label>`;

      if (f.type === "text") {
        html += `<input placeholder="${f.label}" />`;
      }

      if (f.type === "textarea") {
        html += `<textarea rows="2" placeholder="${f.label}"></textarea>`;
      }

      if (f.type === "radio") {
        html += `<div style="margin-top:4px">`;

        f.fields._order.forEach(rk => {
          const rf = f.fields.options[rk];

          html += `
            <div style="margin-left:10px;margin-top:4px">
              <label>
                <input type="radio" name="${key}">
                ${rf.label}
              </label>
              ${renderPreviewChild(rf)}
            </div>
          `;
        });

        html += `</div>`;
      }

      row.innerHTML = html;
      section.appendChild(row);
    });

    box.appendChild(section);
  });
}

function renderPreviewChild(rf) {
  if (rf.type === "text") {
    return `<input style="margin-top:4px" placeholder="${rf.label}"/>`;
  }

  if (rf.type === "textarea") {
    return `<textarea rows="2" style="margin-top:4px" placeholder="${rf.label}"></textarea>`;
  }

  return "";
}

function renderField(method, key, f) {
  return `
    <div class="field-box">
      <b>${f.label}</b> (${f.type})

      <label class="required-row">
        <input type="checkbox" ${f.required?"checked":""}
          onchange="toggleRequired('${method}','${key}',this.checked)">
        Required
      </label>

      ${f.type==="radio" ? renderRadioChildren(method,key,f) : ""}

      <button class="danger" onclick="removeField('${method}','${key}')">‚ùå Remove</button>
    </div>
  `;
}

function renderRadioChildren(method, key, f) {
  const order = f.fields?._order || [];
  const options = f.fields?.options || {};

  return `
    <div class="child-box">
      <b>Radio Options</b>

      ${order.map(ck => {
        const cf = options[ck];

        return `
          <div style="margin-top:6px">
            <input
              placeholder="Option label"
              value="${cf.label || ""}"
              onchange="updateChildLabel('${method}','${key}','${ck}',this.value)"
            >

            <select
              onchange="updateChildType('${method}','${key}','${ck}',this.value)">
              <option value="text" ${cf.type==="text"?"selected":""}>Text</option>
              <option value="textarea" ${cf.type==="textarea"?"selected":""}>Textarea</option>
            </select>

            <label class="required-row">
              <input
                type="checkbox"
                ${cf.required ? "checked" : ""}
                onchange="updateChildRequired('${method}','${key}','${ck}',this.checked)">
              Required
            </label>

            <button
              class="danger"
              onclick="removeChild('${method}','${key}','${ck}')">
              ‚ùå
            </button>
          </div>
        `;
      }).join("")}

      <button
        class="secondary"
        onclick="addChild('${method}','${key}')">
        ‚ûï Add Radio Option
      </button>
    </div>
  `;
}

/* ---------- Actions ---------- */

window.removeDeliveryMethod = m => { delete STATE.methods[m]; renderMethods(); renderPreview();};

window.toggleRequired = (m,f,v) => {
  STATE.methods[m].fields[f].required = v;
};

window.addChild = (m,f) => {
  const k = "tmp_" + Date.now();

  const obj = STATE.methods[m].fields[f].fields;

  obj._order.push(k);

  obj.options[k] = {
    label: "",
    type: "text",
    required: false
  };

  renderMethods();
  renderPreview();
};

window.removeChild = (m,f,k) => {
  const obj = STATE.methods[m].fields[f].fields;

  obj._order = obj._order.filter(x => x !== k);
  delete obj.options[k];

  renderMethods();
  renderPreview();
};

window.updateChildLabel = (m,f,k,v) => {
  if (!v) return;

  const newKey = v
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_|_$/g, "");

  const obj = STATE.methods[m].fields[f].fields;

  // If already same key, just update label
  if (k === newKey) {
    obj.options[k].label = v;
    return;
  }

  // Prevent overwrite
  if (obj.options[newKey]) {
    alert("This option already exists.");
    return;
  }

  // Replace key in order list
  const idx = obj._order.indexOf(k);
  obj._order[idx] = newKey;

  // Move data
  obj.options[newKey] = { ...obj.options[k], label: v };
  delete obj.options[k];

  renderMethods();
  renderPreview();
};
window.updateChildType = (m,f,k,v) => {
  STATE.methods[m].fields[f].fields.options[k].type = v;
};

window.updateChildRequired = (m,f,k,v) => {
  STATE.methods[m].fields[f].fields.options[k].required = v;
};


 function cleanForFirebase(methods) {
  const out = {};

  for (const [m, mObj] of Object.entries(methods)) {
    const res = {};
    mObj._order.forEach(k=>{
      const f = mObj.fields[k];

      if (f.type === "radio") {
        const rf = {};
        f.fields._order.forEach(rk=>{
          rf[rk] = f.fields.options[rk];
        });
        res[k] = { ...f, fields: rf };
      } else {
        res[k] = f;
      }
    });
    out[m] = res;
  }
  return out;
}

  
/* ---------- SAVE ---------- */

window.saveConfig = async function() {
  if (!STATE.jobType) return alert("Nothing to save");

  await update(
    ref(db, `config/driverUI/jobTypes/${STATE.jobType}`),
    {
      deliveryMethods: STATE.methods,
      updatedAt: new Date().toISOString()
    }
  );

  alert("‚úÖ Configuration saved with ordering preserved");
};
</script>

</body>
</html>
