<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Completed Tasks Report</title>

<!-- SheetJS (Excel Export) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f3f3;
  padding: 12px;
}

h2 {
  text-align: center;
}

.filters {
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 12px;
  box-shadow: 0 0 4px rgba(0,0,0,.1);
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
}

.filters select,
.filters button {
  padding: 10px;
  font-size: 14px;
}

button {
  background: #007bff;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

button.back {
  background: #555;
  margin-bottom: 10px;
}

#status {
  text-align: center;
  margin-top: 10px;
  color: #555;
}

/* Loading Screen */
#loadingScreen {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.95);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #ddd;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>

<button class="back" onclick="location.href='index.html'">â¬… Back to Dashboard</button>

<h2>ðŸ“Š Completed Tasks ReportV1.0.2</h2>

<div class="filters">
  <select id="filterJobType">
    <option value="">All Job Types</option>
  </select>

  <select id="filterBA">
    <option value="">All BA</option>
  </select>

  <select id="filterDMZ">
    <option value="">All DMZ</option>
  </select>

  <button onclick="exportReportXLSX()">ðŸ“¥ Export XLSX</button>
</div>

<div id="status">Ready</div>

<div id="loadingScreen">
  <div>
    <div class="spinner"></div>
    <div>Generating reportâ€¦</div>
  </div>
</div>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, get
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  projectId: "driva-pwa",
  storageBucket: "driva-pwa.firebasestorage.app",
  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== UI HELPERS ===== */
function showLoader(text) {
  document.getElementById("loadingScreen").style.display = "flex";
  document.getElementById("status").innerText = text;
}

function hideLoader(msg) {
  document.getElementById("loadingScreen").style.display = "none";
  document.getElementById("status").innerText = msg;
}

/* ===== LOAD FILTER VALUES ===== */
async function loadFilters() {
  const snap = await get(ref(db, "tasks"));
  const tasks = Object.values(snap.val() || {});

  const jobTypes = new Set();
  const bas = new Set();
  const dmzs = new Set();

  tasks.forEach(t => {
    if (t.status !== "COMPLETED") return;
    if (t.JOBTYPE) jobTypes.add(t.JOBTYPE);
    if (t.BA) bas.add(t.BA);
    if (t.DMZ) dmzs.add(t.DMZ);
  });

  fillSelect("filterJobType", jobTypes);
  fillSelect("filterBA", bas);
  fillSelect("filterDMZ", dmzs);
}

function fillSelect(id, values) {
  const sel = document.getElementById(id);
  [...values].sort().forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

/* ===== EXPORT TO XLSX ===== */
window.exportReportXLSX = async function () {
  showLoader("Fetching completed tasksâ€¦");

  try {
    const snap = await get(ref(db, "tasks"));
    const raw = snap.val() || {};

    const jobType = filterJobType.value;
    const ba = filterBA.value;
    const dmz = filterDMZ.value;

    const rows = [];

    Object.values(raw).forEach(t => {
      if (t.status !== "COMPLETED") return;
      if (jobType && t.JOBTYPE !== jobType) return;
      if (ba && t.BA !== ba) return;
      if (dmz && t.DMZ !== dmz) return;

      rows.push({
        JOBTYPE: t.JOBTYPE || "",
        BA: t.BA || "",
        DMZ: t.DMZ || "",
        MRU: t.MRU || "",
        SEQUENCE: t.SEQUENCE || "",
        METERNUMBER: t.METERNUMBER || "",
        ACCOUNTNUMBER: t.ACCOUNTNUMBER || "",
        CUSTOMERNAME: t.CUSTOMERNAME || "",
        ADDRESS: t.ADDRESS || "",
        DELIVERY_TYPE: t.deliveryType || "",
        RECEIVED_BY: t.receivedBy || "",
        RELATIONSHIP: t.relationship || "",
        GATE_COLOR: t.gateColor || "",
        REMARKS: t.remarks || "",
        LATITUDE: t.latitude || "",
        LONGITUDE: t.longitude || "",
        DRIVER_ID: t.AGENTID || "",
        DRIVER_NAME: t.AGENTNAME || "",
        COMPLETED_AT: t.completedAt || ""
      });
    });

    if (!rows.length) {
      hideLoader("No completed tasks found");
      alert("No data for selected filters");
      return;
    }

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Completed Tasks");

    const date = new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb, `Completed_Tasks_Report_${date}.xlsx`);

    hideLoader(`Exported ${rows.length} records`);

  } catch (e) {
    console.error(e);
    hideLoader("Failed to generate report");
    alert("Report generation failed");
  }
};

/* INIT */
loadFilters();
</script>

</body>
</html>
