<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assign Tasks</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f3f3f3;
  padding:10px;
}

h2 { text-align:center; }

.panel {
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

.blue { border-left:5px solid #007bff; }

.small-btn {
  background:#444;
  color:#fff;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  font-size:13px;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th, td {
  border-bottom:1px solid #eee;
  padding:8px 6px;
  text-align:left;
}

th {
  background:#f5f5f5;
  font-weight:bold;
}

tr:hover { background:#f9f9f9; }

#bulkBtn {
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 14px;
  font-weight:bold;
}

#bulkBtn:disabled { background:#aaa; }

.actions {
  display:flex;
  gap:8px;
}
</style>
</head>

<body>

<h2>‚ûï Assign Tasks</h2>

<button onclick="location.href='admin.html'" class="small-btn">‚¨Ö Back</button>

<hr>

<!-- BULK UPLOAD -->
<div class="panel">
  <b>üì§ Bulk Upload Tasks</b><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="uploadCSV(this)" style="margin-top:6px;">Upload CSV</button>
  <div id="uploadStatus" style="font-size:13px;margin-top:6px;"></div>
</div>

<!-- DATE + BULK ACTION -->
<div class="panel blue">
  <div class="actions">
    <input type="date" id="taskDate" style="flex:1;padding:8px;">
    <button id="bulkBtn" disabled onclick="openBulkActions()">Bulk Actions</button>
  </div>
</div>

<!-- TASK TABLE -->
<div class="panel">
  <b>üìù Pending Tasks</b>
  <div style="overflow:auto;margin-top:6px;">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll"></th>
          <th>Customer</th>
          <th>Address</th>
          <th>Driver</th>
          <th>Job Type</th>
          <th>BA</th>
        </tr>
      </thead>
      <tbody id="taskTable">
        <tr><td colspan="6">Select date</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, get, update
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  projectId: "driva-pwa",
  storageBucket: "driva-pwa.firebasestorage.app",
  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const taskDate = document.getElementById("taskDate");
const taskTable = document.getElementById("taskTable");
const bulkBtn = document.getElementById("bulkBtn");
const checkAll = document.getElementById("checkAll");

taskDate.value = new Date().toISOString().split("T")[0];
taskDate.onchange = loadTasks;

let TASKS = [];

/* ===== LOAD TASKS ===== */
async function loadTasks() {
  const date = taskDate.value;
  taskTable.innerHTML = `<tr><td colspan="6">Loading...</td></tr>`;
  bulkBtn.disabled = true;
  checkAll.checked = false;

  const snap = await get(ref(db, "tasks"));
  const raw = snap.val() || {};

  TASKS = Object.keys(raw)
    .map(k => ({ _key: k, ...raw[k] }))
    .filter(t =>
      t.status === "PENDING" &&
      t.createdAt?.startsWith(date)
    );

  renderTable();
}

function renderTable() {
  taskTable.innerHTML = "";

  if (!TASKS.length) {
    taskTable.innerHTML = `<tr><td colspan="6">No pending tasks</td></tr>`;
    return;
  }

  TASKS.forEach(t => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input type="checkbox" data-id="${t._key}" onchange="checkSelection()"></td>
      <td>${t.CUSTOMERNAME || ""}</td>
      <td>${t.ADDRESS || ""}</td>
      <td>${t.driverId || "‚Äî"}</td>
      <td>${t.JOBTYPE || ""}</td>
      <td>${t.BA || ""}</td>
    `;

    taskTable.appendChild(tr);
  });
}

/* ===== SELECTION ===== */
checkAll.onchange = () => {
  const boxes = taskTable.querySelectorAll("input[type=checkbox]");
  boxes.forEach(cb => cb.checked = checkAll.checked);
  checkSelection();
};

window.checkSelection = function () {
  const checked =
    taskTable.querySelectorAll("input[type=checkbox]:checked");

  bulkBtn.disabled = checked.length === 0;
};

/* ===== BULK ACTION ===== */
window.openBulkActions = function () {
  const ids = [...taskTable.querySelectorAll("input[type=checkbox]:checked")]
    .map(cb => cb.dataset.id);

  const action = prompt(
    `Selected ${ids.length} tasks\n\nType:\nTRANSFER\nor\nDELETE`
  );

  if (!action) return;

  if (action.toUpperCase() === "DELETE") {
    bulkDelete(ids);
  } else if (action.toUpperCase() === "TRANSFER") {
    bulkTransfer(ids);
  }
};

async function bulkDelete(ids) {
  if (!confirm(`Delete ${ids.length} tasks?`)) return;

  const updates = {};
  ids.forEach(id => updates[`tasks/${id}`] = null);

  await update(ref(db), updates);
  alert("‚úÖ Tasks deleted");
  loadTasks();
}

async function bulkTransfer(ids) {
  const newDriver = prompt("Enter NEW DRIVER ID:");
  if (!newDriver) return;

  const updates = {};
  ids.forEach(id => {
    updates[`tasks/${id}/driverId`] = newDriver;
  });

  await update(ref(db), updates);
  alert("‚úÖ Tasks transferred");
  loadTasks();
}

/* ===== BULK UPLOAD (UNCHANGED) ===== */
window.uploadCSV = async function (btn) {
  const fileInput = document.getElementById("csvFile");
  const status = document.getElementById("uploadStatus");

  if (!fileInput.files.length) {
    alert("Please select a CSV file");
    return;
  }

  const text = await fileInput.files[0].text();
  const rows = text.replace(/\r/g,"").split("\n").filter(Boolean);

  const headers = rows.shift().split(",");
  const updates = {};
  const base = Date.now();
  const now = new Date().toISOString();

  rows.forEach((row,i)=>{
    const vals = row.split(",");
    const obj = {};
    headers.forEach((h,idx)=>obj[h.trim()] = vals[idx]?.trim() || "");

    updates[`tasks/TASK_${base}_${i}`] = {
      ...obj,
      driverId: obj.AGENTID || "",
      status: "PENDING",
      rowIndex: i+1,
      uploadBatch: base,
      createdAt: now
    };
  });

  await update(ref(db), updates);
  status.innerText = "‚úÖ Upload Complete";
  loadTasks();
};

loadTasks();
</script>

</body>
</html>
