<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Tasks</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f3f3f3;
  padding:10px;
}

h2 { text-align:center; }

.panel {
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 0 4px rgba(0,0,0,.1);
  margin-bottom:12px;
}

.blue { border-left:5px solid #007bff; }

.small-btn {
  background:#444;
  color:#fff;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  font-size:13px;
}

table {
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

th, td {
  border-bottom:1px solid #eee;
  padding:6px;
  text-align:left;
  white-space:nowrap;
}

th {
  background:#f5f5f5;
  font-weight:bold;
}

tr:hover { background:#f9f9f9; }

#bulkBtn {
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:10px 14px;
  font-weight:bold;
}

#bulkBtn:disabled { background:#aaa; }

.actions {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

select, input[type="date"] {
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:13px;
}
</style>
</head>

<body>

<h2>Manage Tasks V4.0.8.5</h2>

<button onclick="location.href='admin.html'" class="small-btn">‚¨Ö Back</button>

<!-- BULK UPLOAD -->
<div class="panel">
  <b>üì§ Bulk Upload Tasks</b><br>
  <input type="file" id="csvFile" accept=".csv">
  <button onclick="uploadCSV(this)" style="margin-top:6px;">Upload CSV</button>
  <div id="uploadStatus" style="font-size:13px;margin-top:6px;"></div>
</div>

<!-- FILTERS + BULK ACTION -->
<div class="panel blue">
  <div class="actions">
    <input type="date" id="filterDateFrom">
    <input type="date" id="filterDateTo">
    <select id="filterDriver"><option value="">All Drivers</option></select>
    <select id="filterJob"><option value="">All Job Types</option></select>
    <select id="filterBA"><option value="">All BA</option></select>
    <select id="filterDMZ"><option value="">All DMZ</option></select>
    <select id="filterMRU"><option value="">All MRU</option></select>
    <button id="bulkBtn" disabled onclick="openBulkActions()">Bulk Action</button>
  </div>
</div>

<!-- TASK TABLE -->
<div class="panel">
  <b>üìù Pending Tasks</b>
  <div style="overflow:auto;margin-top:6px;">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="checkAll"></th>
          <th>Customer</th>
          <th>Address</th>
          <th>Driver</th>
          <th>JobType</th>
          <th>BA</th>
          <th>Created Date Time</th>
        </tr>
      </thead>
      <tbody id="taskTable"></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script type="module">
import { initializeApp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, get, update
} from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  projectId: "driva-pwa",
  storageBucket: "driva-pwa.firebasestorage.app",
  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const table = document.getElementById("taskTable");
const bulkBtn = document.getElementById("bulkBtn");

const filterDateFrom = document.getElementById("filterDateFrom");
const filterDateTo = document.getElementById("filterDateTo");
const filterDriver = document.getElementById("filterDriver");
const filterJob = document.getElementById("filterJob");
const filterBA = document.getElementById("filterBA");
const filterDMZ = document.getElementById("filterDMZ");
const filterMRU = document.getElementById("filterMRU");
const checkAll = document.getElementById("checkAll");

let TASKS = [];

const today = getTodayPH();
filterDateFrom.value = today;
filterDateTo.value = today;
  
filterDateFrom.onchange =
filterDateTo.onchange =
filterDriver.onchange =
filterJob.onchange =
filterBA.onchange =
filterDMZ.onchange =
filterMRU.onchange = applyFilters;

function getTodayPH() {
  return new Date().toLocaleDateString("en-CA", {
    timeZone: "Asia/Manila"
  });
}

function normalizeDate(dateStr) {
  if (!dateStr) return null;

  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;

  return d.toLocaleDateString("en-CA", {
    timeZone: "Asia/Manila"
  });
}

/* ===== PH TIME ===== */
function toPHTime(ts) {
  return new Date(ts).toLocaleString("en-PH", {
    timeZone: "Asia/Manila",
    year:"numeric",
    month:"2-digit",
    day:"2-digit",
    hour:"2-digit",
    minute:"2-digit",
    second:"2-digit"
  });
}

/* ===== LOAD TASKS ===== */
async function loadTasks() {
  const snap = await get(ref(db,"tasks"));
  const raw = snap.val() || {};

  TASKS = Object.keys(raw).map(k=>({ _key:k, ...raw[k] }))
    .filter(t=>t.status==="PENDING");

  buildFilterLists();
  applyFilters();
}



function buildFilterLists() {
  const drivers = new Set();
  const jobs = new Set();
  const bas = new Set();
  const dmzs = new Set();
  const mrus = new Set();

  TASKS.forEach(t=>{
    if(t.driverId) drivers.add(t.driverId);
    if(t.JOBTYPE) jobs.add(t.JOBTYPE);
    if(t.BA) bas.add(t.BA);
    if(t.DMZ) dmzs.add(t.DMZ);
    if(t.MRU) mrus.add(t.MRU);
  });

  filterDriver.innerHTML = `<option value="">All Drivers</option>`;
  filterJob.innerHTML = `<option value="">All Job Types</option>`;
  filterBA.innerHTML = `<option value="">All BA</option>`;
  filterDMZ.innerHTML = `<option value="">All DMZ</option>`;
  filterMRU.innerHTML = `<option value="">All MRU</option>`;

  drivers.forEach(v=>filterDriver.innerHTML += `<option>${v}</option>`);
  jobs.forEach(v=>filterJob.innerHTML += `<option>${v}</option>`);
  bas.forEach(v=>filterBA.innerHTML += `<option>${v}</option>`);
  dmzs.forEach(v=>filterDMZ.innerHTML += `<option>${v}</option>`);
  mrus.forEach(v=>filterMRU.innerHTML += `<option>${v}</option>`);
}

function applyFilters() {
  let data = [...TASKS];

  if (filterDateFrom.value || filterDateTo.value) {
    const from = filterDateFrom.value || "0000-00-00";
    const to   = filterDateTo.value   || "9999-99-99";
  
    data = data.filter(t => {
      const d = normalizeDate(t.createdAt);
      return d && d >= from && d <= to;
    });
  }

  if(filterJob.value)
    data = data.filter(t=>t.JOBTYPE===filterJob.value);

  if(filterBA.value)
    data = data.filter(t=>t.BA===filterBA.value);
  
  if(filterDMZ.value)
    data = data.filter(t=>t.DMZ===filterDMZ.value);

  if(filterMRU.value)
    data = data.filter(t => t.MRU === filterMRU.value);
  

  renderTable(data);
}

/* ===== RENDER ===== */
function renderTable(data) {
  table.innerHTML = "";
  checkAll.checked = false;
  bulkBtn.disabled = true;

  if(!data.length){
    table.innerHTML = `<tr><td colspan="7">No matching tasks</td></tr>`;
    return;
  }

  data.forEach(t=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${t._key}" onchange="checkSelection()"></td>
      <td>${t.CUSTOMERNAME||""}</td>
      <td>${t.ADDRESS||""}</td>
      <td>${t.driverId||"‚Äî"}</td>
      <td>${t.JOBTYPE||""}</td>
      <td>${t.BA||""}</td>
      <td>${toPHTime(t.createdAt)}</td>
    `;
    table.appendChild(tr);
  });
}

/* ===== SELECTION ===== */
checkAll.onchange = () => {
  document.querySelectorAll("#taskTable input[type=checkbox]")
    .forEach(cb => cb.checked = checkAll.checked);
  checkSelection();
};

window.checkSelection = function () {
  const count =
    document.querySelectorAll("#taskTable input:checked").length;
  bulkBtn.disabled = count === 0;
};

/* ===== BULK ACTION ===== */
window.openBulkActions = function () {
  const ids = [...document.querySelectorAll("#taskTable input:checked")]
    .map(cb => cb.dataset.id);

  const action = prompt("Type: TRANSFER or DELETE");

  if(action === "DELETE") bulkDelete(ids);
  else if(action === "TRANSFER") bulkTransfer(ids);
};

async function bulkDelete(ids) {
  if(!confirm(`Delete ${ids.length} tasks?`)) return;
  const updates={};
  ids.forEach(id=>updates[`tasks/${id}`]=null);
  await update(ref(db),updates);
  loadTasks();
}

async function bulkTransfer(ids) {
  const newDriver = prompt("Enter NEW DRIVER ID:");
  if(!newDriver) return;

  const updates={};
  ids.forEach(id=>updates[`tasks/${id}/driverId`]=newDriver);
  await update(ref(db),updates);
  loadTasks();
}

/* ===== BULK UPLOAD ===== */
const REQUIRED_HEADERS = [
  "JOBTYPE",
  "BA",
  "DMZ",
  "MRU",
  "SEQUENCE",
  "METERNUMBER",
  "ACCOUNTNUMBER",
  "CUSTOMERNAME",
  "ADDRESS",
  "ZIPCODE",
  "LATITUDE",
  "LONGITUDE",
  "AGENTID",
  "AGENTNAME"
];

window.uploadCSV = async function(btn){
  const file = document.getElementById("csvFile").files[0];

  if (!file) {
    alert("‚ùå Please select a CSV file");
    return;
  }

  btn.disabled = true;
  btn.innerText = "Uploading‚Ä¶";

  try {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: async function(results) {

        const rows = results.data;

        if (!rows.length) {
          alert("‚ùå CSV has no data rows");
          btn.disabled = false;
          btn.innerText = "Upload CSV";
          return;
        }

        /* ===== VALIDATE HEADERS ===== */
        const headers = Object.keys(rows[0] || {});
        const missing = REQUIRED_HEADERS.filter(h => !headers.includes(h));
        const extra = headers.filter(h => !REQUIRED_HEADERS.includes(h));

        if (missing.length) {
          alert("‚ùå Missing required columns:\n\n" + missing.join(", "));
          btn.disabled = false;
          btn.innerText = "Upload CSV";
          return;
        }

        if (extra.length) {
          alert("‚ùå Extra columns not allowed:\n\n" + extra.join(", "));
          btn.disabled = false;
          btn.innerText = "Upload CSV";
          return;
        }

        /* ===== BUILD UPDATES ===== */
        const updates = {};
        const base = Date.now();
        const now = new Date().toLocaleString("sv-SE", {
          timeZone: "Asia/Manila"
        }).replace(" ", "T");

        rows.forEach((task, index) => {
          const taskId = `TASK_${base}_${index}`;

          updates[`tasks/${taskId}`] = {
            ...task,
            driverId: task.AGENTID || "",
            status: "PENDING",
            rowIndex: index + 1,
            uploadBatch: base,
            createdAt: now
          };
        });

        await update(ref(db), updates);

        alert(`‚úÖ Upload successful!\n\n${rows.length} tasks added.`);
        btn.innerText = "‚úî Done";
        loadTasks();
      }
    });

  } catch (err) {
    console.error(err);
    alert("‚ùå Upload failed. Check console for details.");
    btn.disabled = false;
    btn.innerText = "Upload CSV";
  }
};
loadTasks();
</script>
</body>
</html>
