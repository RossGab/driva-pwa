<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Driver Tasks</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#222222">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  padding: 10px;
}

#appVersion {
  background: #222;
  color: #fff;
  padding: 8px;
  text-align: center;
  margin-bottom: 6px;
}

#offlineBanner {
  background: #c0392b;
  color: #fff;
  padding: 6px;
  text-align: center;
  margin-bottom: 10px;
  display: none;
}

.task {
  background: #fff;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 8px;
  box-shadow: 0 0 4px rgba(0,0,0,0.1);
  border-left: 5px solid orange;
}

.task.completed {
  border-left-color: green;
}

.small {
  font-size: 13px;
  color: #555;
}

.offline-indicator {
  margin-top: 6px;
  font-weight: bold;
  color: #c0392b;
}

button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  font-size: 14px;
  border: none;
  border-radius: 6px;
}

button:disabled {
  background: #aaa;
}

.capture {
  background: #007bff;
  color: #fff;
}

.toggle {
  background: #0069d9;
  color: #fff;
}

img {
  width: 100%;
  margin-top: 8px;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="appVersion"></div>
<div id="offlineBanner">‚ö† Offline ‚Äî photos will upload automatically</div>
<div id="taskList">Loading tasks...</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, get, update, query,
  orderByChild, equalTo
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const VERSION = "Driver v2.6.0";

const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain: "driva-pwa.firebaseapp.com",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  projectId: "driva-pwa",
  storageBucket: "driva-pwa.firebasestorage.app",
  messagingSenderId: "299138219722",
  appId: "1:299138219722:web:623ff6b0a067ea822dfe33"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

/* ================= STORAGE KEYS ================= */
const QUEUE_KEY = "offlineQueue";
const TASK_CACHE_KEY = "cachedTasks";

/* ================= DRIVER ID ================= */
let DRIVER_ID = localStorage.getItem("driverId");
while (!DRIVER_ID) DRIVER_ID = prompt("Enter Driver ID");
localStorage.setItem("driverId", DRIVER_ID);

document.getElementById("appVersion").innerText =
  `Driver: ${DRIVER_ID} | ${VERSION}`;

/* ================= OFFLINE QUEUE ================= */
const getQueue = () =>
  JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");

const setQueue = q =>
  localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

/* ================= NETWORK ================= */
function updateNetwork() {
  document.getElementById("offlineBanner").style.display =
    navigator.onLine ? "none" : "block";
}
window.addEventListener("online", updateNetwork);
window.addEventListener("offline", updateNetwork);
updateNetwork();

/* ================= IMAGE HELPERS ================= */
function compressImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => img.src = e.target.result;

    img.onload = () => {
      const canvas = document.createElement("canvas");
      let w = img.width;
      let h = img.height;

      if (w > 1280) {
        h *= 1280 / w;
        w = 1280;
      }

      canvas.width = w;
      canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);

      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.65);
    };

    reader.readAsDataURL(file);
  });
}

const toBase64 = blob => new Promise(res => {
  const fr = new FileReader();
  fr.onloadend = () => res(fr.result);
  fr.readAsDataURL(blob);
});

/* ================= CAMERA ================= */
let CURRENT_TASK = null;
const camera = document.getElementById("cameraInput");

window.takePicture = key => {
  CURRENT_TASK = key;
  camera.value = "";
  camera.click();
};

camera.addEventListener("change", async e => {
  if (!e.target.files[0] || !CURRENT_TASK) return;

  const blob = await compressImage(e.target.files[0]);

  if (!navigator.onLine) {
    const queue = getQueue();
    queue.push({
      taskKey: CURRENT_TASK,
      image: await toBase64(blob)
    });
    setQueue(queue);
    CURRENT_TASK = null;
    loadTasks();
    return;
  }

  await uploadNow(CURRENT_TASK, blob);
});

/* ================= UPLOAD ================= */
async function uploadNow(taskKey, blob) {
  const taskRef = ref(db, `tasks/${taskKey}`);
  await update(taskRef, { status: "UPLOADING" });

  const imgRef = sRef(storage, `tasks/${taskKey}/${Date.now()}.jpg`);
  await uploadBytes(imgRef, blob);
  const url = await getDownloadURL(imgRef);

  await update(taskRef, {
    status: "COMPLETED",
    imageUrl: url,
    uploadedAt: new Date().toISOString()
  });

  loadTasks();
}

/* ================= OFFLINE SYNC ================= */
setInterval(async () => {
  if (!navigator.onLine) return;
  const queue = getQueue();
  if (!queue.length) return;

  for (const item of queue) {
    const blob = await (await fetch(item.image)).blob();
    await uploadNow(item.taskKey, blob);
  }
  setQueue([]);
}, 5000);

/* ================= LOAD TASKS ================= */
async function loadTasks() {
  const list = document.getElementById("taskList");

  if (!navigator.onLine) {
    const cached = JSON.parse(
      localStorage.getItem(TASK_CACHE_KEY) || "[]"
    );
    if (!cached.length) {
      list.innerHTML = "No cached tasks available offline";
      return;
    }
    renderTasks(cached, true);
    return;
  }

  const snap = await get(
    query(ref(db, "tasks"), orderByChild("driverId"), equalTo(DRIVER_ID))
  );

  const raw = snap.val() || {};
  const tasks = Object.keys(raw).map(k => ({ _key: k, ...raw[k] }));

  localStorage.setItem(TASK_CACHE_KEY, JSON.stringify(tasks));
  renderTasks(tasks, false);
}

/* ================= RENDER ================= */
function renderTasks(tasks, offlineMode) {
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  const offlineMap = Object.fromEntries(
    getQueue().map(i => [i.taskKey, true])
  );

  tasks.sort((a, b) => {
    if (offlineMap[a._key]) return -1;
    if (offlineMap[b._key]) return 1;
    if (a.status === "COMPLETED") return 1;
    if (b.status === "COMPLETED") return -1;
    return 0;
  });

  tasks.forEach(t => {
    const savedOffline = offlineMap[t._key];
    const div = document.createElement("div");

    div.className = `task ${t.status === "COMPLETED" ? "completed" : ""}`;

    div.innerHTML = `
      <b>${t.name}</b>
      <div class="small">${t.address}</div>
      <div class="small">Status: ${t.status}</div>

      ${offlineMode ? `<div class="offline-indicator">üì¶ Offline copy</div>` : ""}
      ${savedOffline ? `<div class="offline-indicator">üïí Photo saved ‚Äì upload later</div>` : ""}

      ${
        savedOffline
          ? `<button disabled>‚è≥ Saved for upload</button>`
          : t.status === "COMPLETED"
            ? `
              <button class="toggle"
                onclick="this.nextElementSibling.style.display =
                this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                üëÅ Show / Hide Photo
              </button>
              <img src="${t.imageUrl}" style="display:none">
            `
            : `<button class="capture" onclick="takePicture('${t._key}')">üì∏ Take Picture</button>`
      }
    `;

    list.appendChild(div);
  });
}

loadTasks();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
