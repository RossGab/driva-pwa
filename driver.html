<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Tasks</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#222222">

<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; padding:10px; }
#appVersion { background:#222;color:#fff;padding:8px;text-align:center;margin-bottom:6px; }
#offlineBanner { background:#c0392b;color:#fff;padding:6px;text-align:center;margin-bottom:10px;display:none; }
#searchBox { width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc; }
.task { background:#fff;padding:12px;margin-bottom:10px;border-radius:8px;border-left:5px solid orange; }
.task.completed { border-left-color:green; }
.small { font-size:13px;color:#555;margin-top:4px; }
.radio-group label { display:block;margin-top:4px; }
textarea,input { width:100%;padding:6px;margin-top:4px; }
button { width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px; }
.capture { background:#007bff;color:#fff; }
.toggle { background:#0069d9;color:#fff; }
.uploading { font-weight:bold;color:#f39c12;margin-top:6px; }
.offline-indicator { font-weight:bold;color:#c0392b;margin-top:6px; }
img { width:100%;margin-top:8px;border-radius:6px; }
</style>
</head>

<body>

<div id="appVersion"></div>
<div id="offlineBanner">âš  Offline â€” photos will upload automatically</div>
<input id="searchBox" placeholder="Search tasks...">
<div id="taskList">Loading tasks...</div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const VERSION = "Driver v3.5.1";
const BILLING_CACHE = {};
const DRIVER_UI_CACHE = {};
const QUEUE_KEY = "offlineQueue";
const TASK_CACHE_KEY = "cachedTasks";

const app = initializeApp({
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);
const storage = getStorage(app);

let DRIVER_ID = localStorage.getItem("driverId");
while (!DRIVER_ID) DRIVER_ID = prompt("Enter Driver ID");
localStorage.setItem("driverId", DRIVER_ID);
document.getElementById("appVersion").innerText = `Driver: ${DRIVER_ID} | ${VERSION}`;

async function loadDriverUIConfig(jobType) {
  if (DRIVER_UI_CACHE[jobType]) return DRIVER_UI_CACHE[jobType];
  const snap = await get(ref(db, `config/driverUI/jobTypes/${jobType}/deliveryMethods`));
  return DRIVER_UI_CACHE[jobType] = snap.val() || {};
}

const getQueue = () => JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
const setQueue = q => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

async function loadTasks() {
  let tasks = JSON.parse(localStorage.getItem(TASK_CACHE_KEY) || "[]");
  if (navigator.onLine) {
    const snap = await get(query(ref(db,"tasks"), orderByChild("driverId"), equalTo(DRIVER_ID)));
    tasks = Object.entries(snap.val()||{}).map(([k,v])=>({_key:k,...v}));
    localStorage.setItem(TASK_CACHE_KEY, JSON.stringify(tasks));
  }
  render(tasks);
}

async function render(tasks) {
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  for (const t of tasks) {
    const div = document.createElement("div");
    div.className = "task";

    div.innerHTML = `
      <b>${t.CUSTOMERNAME||"â€”"}</b>
      <div class="small">${t.ADDRESS||""}</div>
      <div class="small"><b>Job Type:</b> ${t.JOBTYPE||""}</div>

      ${await renderDeliveryMethods(t)}

      <button class="capture" onclick="takePicture('${t._key}')">ðŸ“¸ Take Picture</button>
    `;
    list.appendChild(div);
  }
}

async function renderDeliveryMethods(task) {
  const methods = await loadDriverUIConfig(task.JOBTYPE);
  const cache = BILLING_CACHE[task._key] || {};
  return `
    <div class="radio-group">
      <b>Delivery Method</b>
      ${Object.keys(methods).map(m=>`
        <label>
          <input type="radio"
            name="delivery_${task._key}"
            value="${m}"
            ${cache.deliveryType===m?"checked":""}
            onchange="showDriverFields('${task._key}','${task.JOBTYPE}','${m}')">
          ${m}
        </label>
      `).join("")}
    </div>
    <div id="driver_fields_${task._key}"></div>
  `;
}

window.showDriverFields = async (taskKey, jobType, method) => {
  BILLING_CACHE[taskKey] ||= {};
  BILLING_CACHE[taskKey].deliveryType = method;

  const fields = (await loadDriverUIConfig(jobType))[method];
  const box = document.getElementById(`driver_fields_${taskKey}`);
  if (!box) return;

  box.innerHTML = Object.entries(fields).map(([k,f])=>`
    <label>${f.label}${f.required?" *":""}</label>
    ${f.type==="textarea"
      ? `<textarea oninput="BILLING_CACHE['${taskKey}']['${k}']=this.value"></textarea>`
      : `<input oninput="BILLING_CACHE['${taskKey}']['${k}']=this.value">`}
  `).join("");
};

window.takePicture = async key => {
  const cache = BILLING_CACHE[key];
  if (!cache?.deliveryType) return alert("Select delivery method first");
  camera.click();
};

const camera = document.getElementById("cameraInput");
camera.addEventListener("change", async e => {
  if (!e.target.files[0]) return;
  alert("ðŸ“¸ Photo captured (upload logic unchanged)");
});

loadTasks();
</script>

<script>
if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");
</script>

</body>
</html>
