<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Tasks</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#222">

<style>
body { font-family: Arial; background:#f4f4f4; padding:10px }
#appVersion { background:#222;color:#fff;padding:8px;text-align:center }
#offlineBanner { background:#c0392b;color:#fff;padding:6px;text-align:center;display:none }
.task { background:#fff;padding:12px;margin:10px 0;border-left:5px solid orange }
.task.completed { border-left-color:green }
.small { font-size:13px;color:#555 }
.status { font-weight:bold }
.uploading { color:#f39c12;font-weight:bold }
.failed { color:#c0392b;font-weight:bold }
button { width:100%;padding:10px;margin-top:6px }
button:disabled { background:#aaa }
img { width:100%;margin-top:8px }
</style>
</head>

<body>

<div id="appVersion"></div>
<div id="offlineBanner">‚ö† Offline ‚Äî will upload later</div>
<div id="taskList"></div>

<input type="file" id="camera" accept="image/*" capture="environment" hidden>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, update, query, orderByChild, equalTo }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const VERSION = "Driver v3.3.0";

const app = initializeApp({
  apiKey:"AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  authDomain:"driva-pwa.firebaseapp.com",
  databaseURL:"https://driva-pwa-default-rtdb.firebaseio.com",
  projectId:"driva-pwa",
  storageBucket:"driva-pwa.firebasestorage.app",
  messagingSenderId:"299138219722",
  appId:"1:299138219722:web:623ff6b0a067ea822dfe33"
});

const db = getDatabase(app);
const storage = getStorage(app);

const TASK_CACHE = "cachedTasks";
const uploadingMap = {};
const failedMap = {};

let DRIVER_ID = localStorage.getItem("driverId") || prompt("Driver ID");
localStorage.setItem("driverId", DRIVER_ID);

document.getElementById("appVersion").innerText =
  `Driver: ${DRIVER_ID} | ${VERSION}`;

window.addEventListener("offline", () =>
  document.getElementById("offlineBanner").style.display="block");
window.addEventListener("online", () =>
  document.getElementById("offlineBanner").style.display="none");

/* ================= HELPERS ================= */
const getCachedTasks = () =>
  JSON.parse(localStorage.getItem(TASK_CACHE) || "[]");

function render(tasks) {
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  tasks.sort((a,b)=>{
    const sa = statusOf(a), sb = statusOf(b);
    return ({PENDING:1,UPLOADING:2,COMPLETED:3}[sa]) -
           ({PENDING:1,UPLOADING:2,COMPLETED:3}[sb]);
  });

  tasks.forEach(t=>{
    const status = statusOf(t);
    const div = document.createElement("div");
    div.className = `task ${status==="COMPLETED"?"completed":""}`;
    div.innerHTML = `
      <b>${t.name}</b>
      <div class="small">${t.address}</div>
      <div class="status">Status: ${status}</div>
      ${status==="UPLOADING"?`<div class="uploading">‚¨Ü Uploading...</div>`:""}
      ${status==="FAILED"?`<div class="failed">‚ùå Retry pending</div>`:""}
      ${
        status==="PENDING"
        ? `<button onclick="takePhoto('${t._key}')">üì∏ Take Picture</button>`
        : status==="COMPLETED"
          ? `<img src="${t.imageUrl}">`
          : `<button disabled>${status}</button>`
      }
    `;
    list.appendChild(div);
  });
}

function statusOf(t) {
  if (t.status==="COMPLETED") return "COMPLETED";
  if (uploadingMap[t._key]) return "UPLOADING";
  if (failedMap[t._key]) return "FAILED";
  return "PENDING";
}

/* ================= LOAD ================= */
async function loadTasks() {
  const snap = await get(
    query(ref(db,"tasks"),orderByChild("driverId"),equalTo(DRIVER_ID))
  );
  const raw = snap.val() || {};
  const tasks = Object.keys(raw).map(k=>({_key:k,...raw[k]}));
  localStorage.setItem(TASK_CACHE,JSON.stringify(tasks));
  render(tasks);
}

/* ================= CAMERA ================= */
const camera = document.getElementById("camera");
let CURRENT=null;

window.takePhoto = id => {
  CURRENT=id;
  camera.value="";
  camera.click();
};

camera.onchange = async e => {
  const file = e.target.files[0];
  if(!file) return;

  uploadingMap[CURRENT]=true;
  render(getCachedTasks()); // ‚úÖ OPTIMISTIC RENDER

  try {
    const imgRef = sRef(storage,`tasks/${CURRENT}/${Date.now()}.jpg`);
    await uploadBytes(imgRef,file);
    const url = await getDownloadURL(imgRef);

    await update(ref(db,`tasks/${CURRENT}`),{
      status:"COMPLETED",
      imageUrl:url,
      uploadedAt:new Date().toISOString()
    });

    delete uploadingMap[CURRENT];
    await loadTasks(); // ‚úÖ ONLY NOW refresh

  } catch {
    failedMap[CURRENT]=true;
    delete uploadingMap[CURRENT];
    render(getCachedTasks());
  }
};

loadTasks();
</script>

</body>
</html>
