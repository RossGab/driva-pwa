<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Driver Tasks</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#222222">

<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; padding:10px; }
#appVersion { background:#222;color:#fff;padding:8px;text-align:center;margin-bottom:6px; }
#offlineBanner { background:#c0392b;color:#fff;padding:6px;text-align:center;margin-bottom:10px;display:none; }
#searchBox { width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid #ccc;font-size:14px; }
.task { background:#fff;padding:12px;margin-bottom:10px;border-radius:8px;border-left:5px solid orange; }
.task.completed { border-left-color:green; }
.small { font-size:13px;color:#555;margin-top:4px; }
.radio-group label { display:block;margin-top:4px; }
textarea { width:100%;min-height:60px;margin-top:6px;padding:6px;font-size:14px; }
.offline-indicator { font-weight:bold;color:#c0392b;margin-top:6px; }
.uploading { font-weight:bold;color:#f39c12;margin-top:6px; }
button { width:100%;padding:10px;margin-top:6px;border-radius:6px;border:none;font-size:14px; }
.capture { background:#007bff;color:#fff; }
.toggle { background:#0069d9;color:#fff; }
img { width:100%;margin-top:8px;border-radius:6px; }
</style>
</head>

<body>

<div id="appVersion"></div>
<div id="offlineBanner">‚ö† Offline ‚Äî photos will upload automatically</div>
<input id="searchBox" placeholder="Search tasks">
<div id="taskList">Loading tasks‚Ä¶</div>
<input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const VERSION = "Driver v3.4.18-DYNAMIC";
const BILLING_CACHE = {};
const DRIVER_UI_CACHE = {};

const firebaseConfig = {
  apiKey: "AIzaSyDFW61pnwLvh6HGKWt10zLYNr860fI8vkg",
  databaseURL: "https://driva-pwa-default-rtdb.firebaseio.com",
  storageBucket: "driva-pwa.firebasestorage.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const QUEUE_KEY = "offlineQueue";
const TASK_CACHE_KEY = "cachedTasks";
const processingMap = {};
const uploadingMap = {};
let SEARCH_TERM = "";

let DRIVER_ID = localStorage.getItem("driverId");
while (!DRIVER_ID) DRIVER_ID = prompt("Enter Driver ID");
localStorage.setItem("driverId", DRIVER_ID);
appVersion.innerText = `Driver: ${DRIVER_ID} | ${VERSION}`;

async function loadDriverUI(jobType) {
  if (DRIVER_UI_CACHE[jobType]) return DRIVER_UI_CACHE[jobType];
  const snap = await get(ref(db, `config/driverUI/jobTypes/${jobType}/deliveryMethods`));
  DRIVER_UI_CACHE[jobType] = snap.val() || {};
  return DRIVER_UI_CACHE[jobType];
}

/* ===== NETWORK ===== */
function updateNetwork() {
  offlineBanner.style.display = navigator.onLine ? "none" : "block";
}
window.addEventListener("online", updateNetwork);
window.addEventListener("offline", updateNetwork);
updateNetwork();

/* ===== QUEUE ===== */
const getQueue = () => JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
const setQueue = q => localStorage.setItem(QUEUE_KEY, JSON.stringify(q));

/* ===== IMAGE ===== */
function compressImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    const r = new FileReader();
    r.onload = e => img.src = e.target.result;
    img.onload = () => {
      const c = document.createElement("canvas");
      let w = img.width, h = img.height;
      if (w > 1280) { h *= 1280 / w; w = 1280; }
      c.width = w; c.height = h;
      c.getContext("2d").drawImage(img, 0, 0, w, h);
      c.toBlob(b => resolve(b), "image/jpeg", 0.65);
    };
    r.readAsDataURL(file);
  });
}

const toBase64 = b => new Promise(r => {
  const f = new FileReader();
  f.onloadend = () => r(f.result);
  f.readAsDataURL(b);
});

/* ===== CAMERA ===== */
let CURRENT_TASK = null;
cameraInput.onchange = async e => {
  if (!e.target.files[0] || !CURRENT_TASK) return;

  if (!validateDynamic(CURRENT_TASK)) {
    CURRENT_TASK = null;
    return;
  }

  processingMap[CURRENT_TASK] = true;
  loadTasks();

  const takenAt = new Date().toISOString();
  const blob = await compressImage(e.target.files[0]);
  const cached = JSON.parse(localStorage.getItem(TASK_CACHE_KEY) || "[]");
  const task = cached.find(t => t._key === CURRENT_TASK);
  const fname = `${task._key}_${takenAt.replace(/[:.]/g,"-")}_${DRIVER_ID}.jpg`;

  if (!navigator.onLine) {
    getQueue().push({
      taskKey: CURRENT_TASK,
      image: await toBase64(blob),
      takenAt,
      deliveryData: BILLING_CACHE[CURRENT_TASK] || {},
      filename: fname
    });
    setQueue(getQueue());
    delete processingMap[CURRENT_TASK];
    loadTasks();
    return;
  }

  uploadingMap[CURRENT_TASK] = true;
  delete processingMap[CURRENT_TASK];
  loadTasks();

  await uploadNow(CURRENT_TASK, blob, takenAt, fname);
  delete uploadingMap[CURRENT_TASK];
  loadTasks();
};

async function uploadNow(taskKey, blob, takenAt, filename) {
  const imgRef = sRef(storage, `tasks/${taskKey}/${filename}`);
  await uploadBytes(imgRef, blob);
  const url = await getDownloadURL(imgRef);

  await update(ref(db, `tasks/${taskKey}`), {
    status: "COMPLETED",
    imageUrl: url,
    takenAt,
    uploadedAt: new Date().toISOString(),
    deliveryData: BILLING_CACHE[taskKey] || {}
  });
}

/* ===== OFFLINE RETRY ===== */
setInterval(async () => {
  if (!navigator.onLine) return;
  const q = getQueue();
  if (!q.length) return;

  for (const i of q) {
    const blob = await (await fetch(i.image)).blob();
    await uploadNow(i.taskKey, blob, i.takenAt, i.filename);
  }
  setQueue([]);
  loadTasks();
}, 5000);

/* ===== LOAD TASKS ===== */
async function loadTasks() {
  let tasks = JSON.parse(localStorage.getItem(TASK_CACHE_KEY) || "[]");
  if (navigator.onLine) {
    const snap = await get(query(ref(db,"tasks"),orderByChild("driverId"),equalTo(DRIVER_ID)));
    const raw = snap.val() || {};
    tasks = Object.keys(raw).map(k => ({ _key:k, ...raw[k] }));
    localStorage.setItem(TASK_CACHE_KEY, JSON.stringify(tasks));
  }
  render(tasks);
}

/* ===== RENDER ===== */
async function render(tasks) {
  taskList.innerHTML = "";
  for (const t of tasks) {
    const status = t.status || "PENDING";
    const div = document.createElement("div");
    div.className = `task ${status==="COMPLETED"?"completed":""}`;

    let html = `
  <b>${t.CUSTOMERNAME || "‚Äî"}</b>

  <div class="small">
    üìç ${t.ADDRESS || "‚Äî"}
  </div>

  <div class="small">
    <b>Account #:</b> ${t.ACCOUNTNUMBER || "‚Äî"}
  </div>

  <div class="small">
    <b>MRU:</b> ${t.MRU || "‚Äî"}
  </div>

  <div class="small">
    <b>Meter #:</b> ${t.METERNUMBER || "‚Äî"}
  </div>

  <div class="small">
    <b>DMZ:</b> ${t.DMZ || "‚Äî"}
  </div>

  <div class="small">
    <b>Sequence:</b> ${t.SEQUENCE || "‚Äî"}
  </div>

  <div class="small">
    <b>Job Type:</b> ${t.JOBTYPE || "‚Äî"}
  </div>

  <div class="small">
    <b>Status:</b> ${status}
  </div>
`;

    if (status === "PENDING") {
      html += await renderDynamicDelivery(t);
      html += `<button class="capture" onclick="CURRENT_TASK='${t._key}';cameraInput.click()">üì∏ Take Picture</button>`;
    }

    if (status === "COMPLETED") {
      html += `<button class="toggle" onclick="this.nextElementSibling.style.display='block'">Show Photo</button><img src="${t.imageUrl}" style="display:none">`;
    }

    div.innerHTML = html;
    taskList.appendChild(div);
  }
}

async function renderDynamicDelivery(t) {
  const methods = await loadDriverUI(t.JOBTYPE);
  if (!methods || !Object.keys(methods).length) return "";

  let html = `<div class="radio-group"><b>Delivery Method</b>`;
  for (const m of Object.keys(methods)) {
    html += `
      <label>
        <input type="radio" name="delivery_${t._key}" value="${m}"
          onchange="showDynamicFields('${t._key}','${t.JOBTYPE}','${m}')">
        ${m}
      </label>`;
  }
  html += `</div><div id="dyn_${t._key}"></div>`;
  return html;
}

window.showDynamicFields = async function(taskKey, jobType, method) {
  if (!BILLING_CACHE[taskKey]) BILLING_CACHE[taskKey] = {};
  BILLING_CACHE[taskKey].deliveryType = method;

  const cfg = await loadDriverUI(jobType);
  const box = document.getElementById(`dyn_${taskKey}`);
  let html = "";

  for (const f of Object.values(cfg[method])) {
    html += f.type === "textarea"
      ? `<textarea placeholder="${f.label}" oninput="BILLING_CACHE['${taskKey}']['${f.label}']=this.value"></textarea>`
      : `<input placeholder="${f.label}" oninput="BILLING_CACHE['${taskKey}']['${f.label}']=this.value">`;
  }
  box.innerHTML = html;
};

function validateDynamic(taskKey) {
  const data = BILLING_CACHE[taskKey];
  if (!data?.deliveryType) {
    alert("Select delivery method");
    return false;
  }
  return true;
}

loadTasks();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
